#!/usr/bin/env bpftrace
//
// auto-compare openat() and mmap() against CSV baseline
//

BEGIN {
    @sockopt[0, 7] = 1;
@sockopt[0, 12]= 1;
@sockopt[1, 29]= 1;
@sockopt[1, 20]= 1;
@sockopt[0, 10]= 2;
@sockopt[270, 11]= 3;
@sockopt[1, 12]= 4;
@sockopt[1, 21]= 7;
@sockopt[1, 8]= 12;
@sockopt[1, 9]= 18;
@sockopt[6, 1]= 21;
@sockopt[0, 8]= 22;
@sockopt[0, 50]= 22;
@sockopt[6, 5]= 30;
@sockopt[6, 4]= 30;
@sockopt[6, 6]= 30;
@sockopt[1, 7]= 37;
@sockopt[0, 11]= 40;
@sockopt[1, 16]= 48;
@sockpair[1, 526337, 0]= 4;
@sockpair[1, 1, 0]= 8;
@sockpair[1, 524289, 0]= 8;
@sockpair[1, 524293, 0]= 10;
@sockpair[1, 5, 0]= 15;


}

tracepoint:syscalls:sys_enter_setsockopt {
    $f = args->level;
    $m = args->optname;

    /* unseen or rare combo → anomaly */
    if (!@sockopt[$f,$m] || @sockopt[$f,$m] < $1) {
        @sockopt_anomaly[$f,$m]++;
        printf("\n=== Potential Anomaly sockopt pid=%d comm=%s level=%x optname=%o ===\n", pid, comm, $f, $m);
        @sockopt[$f,$m]++;
    }
}

tracepoint:syscalls:sys_enter_socketpair {
    $f = args->family;
    $m = args->type;
    $k = args->protocol;

    /* unseen or rare combo → anomaly */
    if (!@sockpair[$f,$m,$k] || @sockpair[$f,$m,$k] < $1) {
        @sockpair_anomaly[$f,$m,$k]++;
        printf("\n=== Potential Anomaly socketpair pid=%d comm=%s family=%x type=%d protocol=%d ===\n", pid, comm, $f, $m, $k);
        @sockpair[$f,$m,$k]++;
    }
}
